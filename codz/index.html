<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en-us">
<head>
    <base href="https://rawcdn.githack.com/gn-math/assets/main/308/">
    <meta charset="utf-8">
    <title>NZ: Portable</title>
    <link rel="icon" href="nzportable.ico">
    <style>
        html, body {
            background-color: #000000;
            color: #808080;
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        .emscripten {
            padding-right: 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
        }
        div.emscripten {
            text-align: center;
            padding: 0;
            margin: 0;
        }
        canvas.emscripten {
            border: 0px none;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            display: block;
            background: #000;
        }
        #propellerads-banner {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            max-width: 468px;
            width: 100%;
            display: none;
        }
        @media (max-width: 480px) {
            #propellerads-banner {
                max-width: 320px;
                height: 50px;
            }
        }
    </style>
</head>
<body ondrop="gotdrop(event);" ondragover="event.preventDefault()">
    <div class="emscripten" id="status">Please allow/unblock our javascript to play.</div>
    <div id="dropzone" ondrop="gotdrop(event);" ondragover="event.preventDefault()" hidden=1>Drop Zone</div>
    <button type="button" onclick="begin()" id="begin" hidden=1>Click To Begin!</button>
    <div class="emscripten">
        <progress value="0" max="100" id="progress" hidden=1></progress>
    </div>
    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" hidden=1></canvas>

    <script type='text/javascript'>
        // Connect to canvas
        var Module = {
            files: {
                "default.fmf": "default.fmf",
                "nzp/game.pk3": "nzp/game.pk3",
                "nzp/progs.pk3": "nzp/progs.pk3"
            },
            print: function(msg) { console.log(msg); },
            printErr: function(text) { console.error(text); },
            canvas: document.getElementById('canvas'),
            setStatus: function(text) {
                if (Module.setStatus.interval) clearInterval(Module.setStatus.interval);
                const statusElement = document.getElementById('status');
                const progressElement = document.getElementById('progress');
                const m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
                if (m) {
                    text = m[1];
                    const progress = parseInt(m[2]) / parseInt(m[4]) * 100;
                    progressElement.value = Math.min(progress, 100);
                    progressElement.max = 100;
                    progressElement.hidden = false;
                } else {
                    progressElement.value = 0;
                    progressElement.max = 100;
                    progressElement.hidden = true;
                }
                statusElement.innerHTML = text;
                statusElement.hidden = !text;
            },
            totalDependencies: 0,
            monitorRunDependencies: function(left) {
                this.totalDependencies = Math.max(this.totalDependencies, left);
                Module.setStatus(left ? `Preparing... (${this.totalDependencies - left}/${this.totalDependencies})` : 'All downloads complete.');
            },
            postRun: [
                function() {
                    if (Module["sched"] === undefined) {
                        showError("Initialization failed: Game logic error (Module.sched undefined)");
                    } else {
                        console.log("Game initialized successfully");
                        document.getElementById('canvas').hidden = false;
                        document.getElementById('propellerads-banner').style.display = 'block';
                        // Verify rendering
                        setTimeout(() => {
                            const gl = Module.canvas.getContext('webgl');
                            if (!gl || gl.isContextLost() || gl.getError() !== gl.NO_ERROR) {
                                showError("Home screen failed: WebGL rendering error");
                            } else {
                                console.log("Home screen should be visible. WebGL context active.");
                            }
                        }, 5000);
                    }
                }
            ],
        };

        function showError(msg) {
            const statusElement = document.getElementById('status');
            statusElement.innerHTML = msg;
            statusElement.style.color = 'red';
            console.error(msg);
        }

        async function checkFile(url) {
            try {
                const res = await fetch(url, { method: 'HEAD', mode: 'cors' });
                if (!res.ok) throw new Error(`Inaccessible: ${url} (Status: ${res.status})`);
                return true;
            } catch (err) {
                showError(`Script error: ${err.message}`);
                return false;
            }
        }

        function begin() {
            if (Module.began) return;
            Module.began = true;
            document.getElementById('dropzone').hidden = true;
            document.getElementById('begin').hidden = true;
            Module.setStatus('Downloading...');

            // Verify files
            const files = ["ftewebgl.js", "default.fmf", "nzp/game.pk3", "nzp/progs.pk3"];
            Promise.all(files.map(file => checkFile(file))).then(results => {
                if (results.every(r => r)) {
                    const s = document.createElement('script');
                    s.src = "ftewebgl.js";
                    s.type = "text/javascript";
                    s.charset = "utf-8";
                    s.onerror = () => showError("Script error: Failed to load ftewebgl.js");
                    s.onload = () => console.log("ftewebgl.js loaded successfully");
                    document.head.appendChild(s);
                } else {
                    showError("Script error: Missing game files");
                }
            });
        }

        function fixupfilepath(fname, path) {
            if (path != "") return path + fname;
            const ext = fname.substr(fname.lastIndexOf('.') + 1);
            if (ext == 'fmf' || ext == 'kpf') return fname;
            if (ext == 'bsp' || ext == 'map' || ext == 'lit' || ext == 'lux') return "id1/maps/" + fname;
            return "id1/" + fname;
        }

        function showfiles() {
            if (Module.began) return;
            Module.setStatus('');
            document.getElementById('dropzone').hidden = false;
            document.getElementById('begin').hidden = false;
            let nt = "Drag gamedirs or individual package files here to make them available!<br/>Active Files:<br/><pre>";
            const keys = Object.keys(Module.files);
            for (let i = 0; i < keys.length; i++) {
                if (Module.files[keys[i]] instanceof ArrayBuffer) {
                    let sz = Module.files[keys[i]].byteLength;
                    if (sz > 512 * 1024) sz = (sz / (1024 * 1024)).toFixed(2) + "mb";
                    else if (sz > 512) sz = (sz / 1024).toFixed(2) + "kb";
                    else sz = sz + " bytes";
                    nt += `    ${keys[i]} (${sz})<br/>`;
                } else nt += `    ${keys[i]}<br/>`;
            }
            nt += `</pre>(${keys.length} files)`;
            document.getElementById('dropzone').innerHTML = nt;
        }

        async function scanfiles(item, path) {
            if (item.isFile) {
                item.file(f => {
                    const n = fixupfilepath(f.name, path);
                    Module.files[n] = f.arrayBuffer();
                    Module.files[n].then(buf => {
                        Module.files[n] = buf;
                        showfiles();
                    });
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                dirReader.readEntries(entries => {
                    for (let i = 0; i < entries.length; i++) scanfiles(entries[i], path + item.name + "/");
                });
            }
        }

        function gotdrop(ev) {
            ev.preventDefault();
            for (let i = 0; i < ev.dataTransfer.items.length; i++) {
                if (ev.dataTransfer.items[i].webkitGetAsEntry) {
                    const d = ev.dataTransfer.items[i].webkitGetAsEntry();
                    if (d) scanfiles(d, "");
                } else if (ev.dataTransfer.items[i].kind === 'file') {
                    const f = ev.dataTransfer.items[i].getAsFile();
                    const n = fixupfilepath(f.name);
                    Module.files[n] = f.arrayBuffer();
                    Module.files[n].then(buf => {
                        Module.files[n] = buf;
                        showfiles();
                    });
                }
            }
            showfiles();
        }

        // Check WebGL support
        const gl = document.getElementById('canvas').getContext('webgl');
        if (!gl) {
            showError("WebGL not supported. Try a different browser or device.");
        } else {
            console.log("WebGL supported:", gl.getParameter(gl.VERSION));
            if (window.location.hash != "" || Object.keys(Module.files).length) begin();
            else showfiles();
        }
    </script>

    <!-- PropellerAds Banner -->
    <div id="propellerads-banner">
        <script>(function(s){s.dataset.zone='9971186',s.src='https://groleegni.net/vignette.min.js',s.onerror=() => {console.error('PropellerAds failed'); document.getElementById('propellerads-banner').style.display = 'none';}})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))</script>
    </div>

    <img src="https://hits.sh/hits.sh/nzp-team.github.io/latest/game.html/hits.svg" style="opacity:0;width:0px;">
</body>
</html>
