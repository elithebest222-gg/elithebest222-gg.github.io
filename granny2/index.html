<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Unity WebGL Player | Granny 2</title>
    <link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/TemplateData/favicon.ico"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/TemplateData/styles.css"/>
    <style>
        @media (max-width: 480px) {
            #propellerads-banner { max-width: 320px; height: 50px; }
        }
    </style>
</head>
<body>
    <div id="unity-container" style="position: absolute; width: 100%; height: 100%; left: 0; top: 0;">
        <canvas id="unity-canvas" style="position: absolute; width: 100%; height: 100%;"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-warning"></div>
    </div>

    <!-- PropellerAds Banner -->
    <div id="propellerads-banner" style="position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 728px; width: 100%; display: none;">
        <script>(function(s){s.dataset.zone='9971186',s.src='https://groleegni.net/vignette.min.js',s.onerror=() => {console.error('PropellerAds failed'); document.getElementById('propellerads-banner').style.display = 'none';}})(document.body.appendChild(document.createElement('script')))</script>
    </div>

    <script>
        const canvas = document.querySelector("#unity-canvas");
        const loadingBar = document.querySelector("#unity-loading-bar");
        const progressBarFull = document.querySelector("#unity-progress-bar-full");
        const warningBanner = document.querySelector("#unity-warning");

        function showError(msg) {
            const div = document.createElement('div');
            div.innerHTML = msg;
            div.style = 'background: red; padding: 10px;';
            warningBanner.appendChild(div);
            warningBanner.style.display = 'block';
            console.error(msg);
        }

        async function checkFile(url) {
            try {
                const res = await fetch(url, { method: 'HEAD', mode: 'cors' });
                if (!res.ok) throw new Error(`Inaccessible: ${url}`);
                return true;
            } catch (err) {
                showError(err.message);
                return false;
            }
        }

        async function mergeFiles(parts, onProgress) {
            let loaded = 0;
            try {
                const blobs = await Promise.all(parts.map(async part => {
                    const res = await fetch(part, { mode: 'cors' });
                    if (!res.ok) throw new Error(`Fetch failed: ${part}`);
                    loaded++;
                    if (onProgress) onProgress(loaded / parts.length);
                    return res.blob();
                }));
                return URL.createObjectURL(new Blob(blobs));
            } catch (err) {
                throw new Error(`Merge failed: ${err.message}`);
            }
        }

        async function initializeGame() {
            const buildUrl = "https://cdn.jsdelivr.net/gh/forms-docs-slides-glgl/ngng@main/Build";
            const loaderUrl = buildUrl + "/Granny 2.loader.js";
            const dataParts = [
                buildUrl + "/Granny 2_part1.data",
                buildUrl + "/Granny 2_part2.data",
                buildUrl + "/Granny 2_part3.data"
            ];
            const wasmParts = [
                buildUrl + "/Granny 2_part1.wasm",
                buildUrl + "/Granny 2_part2.wasm"
            ];
            const frameworkUrl = buildUrl + "/Granny 2.frameworkx.js";

            loadingBar.style.display = "block";

            // Verify all files are accessible
            const files = [loaderUrl, frameworkUrl, ...dataParts, ...wasmParts];
            for (const file of files) {
                if (!(await checkFile(file))) return;
            }

            try {
                const [dataUrl, wasmUrl] = await Promise.all([
                    mergeFiles(dataParts, p => progressBarFull.style.width = (50 * p) + "%"),
                    mergeFiles(wasmParts, p => progressBarFull.style.width = (50 + 50 * p) + "%")
                ]);

                const config = {
                    dataUrl,
                    frameworkUrl,
                    codeUrl: wasmUrl,
                    streamingAssetsUrl: "StreamingAssets",
                    companyName: "Awesome",
                    productName: "Granny 2",
                    productVersion: "1.0",
                    showBanner: (msg, type) => type === 'error' && showError(msg)
                };

                const script = document.createElement("script");
                script.src = loaderUrl;
                script.async = true;
                script.onerror = () => showError(`Loader failed: ${loaderUrl}`);
                script.onload = () => {
                    if (typeof createUnityInstance === 'undefined') return showError('Unity loader undefined');
                    createUnityInstance(canvas, config, p => progressBarFull.style.width = (100 * p) + "%")
                        .then(() => {
                            loadingBar.style.display = "none";
                            document.getElementById('propellerads-banner').style.display = 'block';
                        })
                        .catch(err => showError(`Unity error: ${err.message}`));
                };
                document.body.appendChild(script);
            } catch (err) {
                showError(`Game failed: ${err.message}`);
            }
        }

        initializeGame();
    </script>
</body>
</html>
